os: linux

dist: xenial

language: erlang

branches:
  only:
  - master
  - /^\d+\..*/ # version tags

stages:
  - basic
  - test
  - website

jobs:
  fast_finish: true

  # Jobs that are allowed to fail:
  allow_failures:
  - env: TEST=".travis/travis_has_latest_otp_version"
  - env: TEST="make -C docs test-external-travis"

  include:

  # When otp_release is unspecified, the first value in the corresponding
  # list further down in this file will be used

  # Check that the latest Erlang version is tested
  # See the warning printed by the script to understand why this test
  # has a separate otp_release specification.
  - env: TEST=".travis/travis_has_latest_otp_version"
    otp_release: 23.1
    stage: basic

  # Check dialyzer
  - env: TEST="make dialyzer"
    stage: basic

  # Check lint
  - env: TEST="make lint"
    stage: basic

  # FLAG is used by Codecov reporter (.travis/after_success)
  - env: TEST="make tests-unit" FLAG="unit_tests"
    stage: basic

  # Test documentation
  - env: TEST="make -C doc test"
    stage: basic

  # Test website
  - env: TEST="make -C docs test"
    stage: website

  # Test external links separately, cause they can break unexpectedly
  - env: TEST="make -C docs test-external-travis"
    stage: website
    addons:
      apt:
        packages:
        - libcurl4-openssl-dev # required to avoid SSL errors in htmlproofer

env:

  # FLAG is used by Codecov reporter (.travis/after_success)
  - TEST=".travis/run make tests-1" FLAG="tests-1"
  - TEST=".travis/run make tests-2" FLAG="tests-2"
  - TEST=".travis/run make tests-real" FLAG="tests_real"

otp_release:

  # Two latest minor versions of the most recent OTP release.

  # When a new major OTP release is enabled, also update the badge in
  # README.md and the argument given to generate_version_hrl in
  # rebar.config

  - 23.0

  # Last minor version of older OTP releases

  - 22.3
  - 21.3
  - 20.3


# Travis build steps configuration

addons:
  apt:
    packages:
    - moreutils

cache:
  timeout: 5
  directories:
  - "$HOME/.cache/rebar3"

before_script:
  - .travis/before_script

script:
 - $TEST

after_success:
  - .travis/after_success

after_failure:
  - .travis/after_failure
